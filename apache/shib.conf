LoadModule shib_module modules/mod_shib.so
LoadModule headers_module modules/mod_headers.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so

# 大容量転送向けタイムアウト設定（5分）
Timeout 300
ProxyTimeout 300
KeepAlive On
KeepAliveTimeout 30

UseCanonicalName On
ProxyPreserveHost On
RequestHeader set X-Forwarded-Proto "https"

# Shibboleth ハンドラ公開 (/Shibboleth.sso/*)
<Location /Shibboleth.sso>
    SetHandler shib
</Location>

# アプリ公開パスは認証必須
<Location /secure>
    AuthType shibboleth
    ShibRequestSetting requireSession 1
    Require valid-user
</Location>

# アップロード時のリクエストボディ上限（必要に応じてアプリ側で制御）
<Location /secure/upload>
    LimitRequestBody 0
</Location>

# ヘッダ偽装対策 + 属性連携
RequestHeader unset X-USER-ID
RequestHeader set X-USER-ID "%{userid}e" env=userid

# 大容量バイナリ配信時の不要な圧縮を抑止
SetEnvIfNoCase Request_URI "\.(zip|gz|tar|7z|pdf|mp4|mov|mkv)$" no-gzip=1

# コンテナ外（ホストOS常駐）Webアプリ localhost:8081 へ転送
ProxyPass /secure http://host.docker.internal:8081/
ProxyPassReverse /secure http://host.docker.internal:8081/

# 切り分けしやすいように処理時間（%D）を出力
LogFormat "%h %l %u %t \"%r\" %>s %b D=%D userid=%{userid}e" shib_combined
CustomLog /var/log/httpd/access_log shib_combined
ErrorLog /var/log/httpd/error_log
